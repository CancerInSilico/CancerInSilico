---
title: "User Manual"
author: "Thomas D. Sherman, Raymond Cheng, Elana J. Fertig"
date: "`r doc_date()`"
package: "`r pkg_ver('CellModel')`"
bibliography: References.bib
vignette: >
  %\VignetteIndexEntry{User Manual}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: 
  BiocStyle::html_document
---

```{r include=FALSE, cache=FALSE}
library(CellModel)
```

# Introduction

The main objective of the *CellModel* package is to provide a single, consistent interface for running cell-based models. In this first iteration of the package, we have implemented a similiar model to the one presented in @DRASDO2003. Subsequent versions of the package will include more types of cell-based models [see @SZABO2013 for an overview of different approaches]. This class of models starts at the cellular level and simulates each cell's interactions with its neighbors and its local environment. By doing so, it places focus on the cell-cell dynamics which allows for a detailed exploration of how mechanisms at the cellullar level effect overall population dynamics. This does come at a cost, however, since these models can be difficult to parametrize and often take a considerable amount of time to run.

The model in @DRASDO2003 was chosen to be implemented first since it is simple to parametrize and reasonably efficient. The only mechanisms modelled are the progression through the cell-cycle and intercellular forces. The cell-cycle is modelled as a cell growing during Interphase and dividing during Mitosis. The primary use of the cell-cycle is for timing between divisions and ensuring the cell has enough room to divide. Intercellular forces are modelled by the way cells attempt to arrange themselves with respsect to one another. Cells arrange themselves according to the "competition between atrractive interactions due to adhesion molecules anchored in the cell membranes and repulsive contributions ... from the limited cell deform-ability and compressibility" [@DRASDO2003]. Furthermore, cells cannot occupy space already occupied by another cell. This property is especially important for larger, denser cell populations. "As the number of cells that has to be pushed aside by a dividing cell in order to obtain free space for growth becomes too large, the cell stops in one of the cell-cycle check points" [@DRASDO2003]. This gives rise to an exterior layer of proliferating cells and an interior core of quiet cells as the cell population becomes dense.

(note: Since this model is not lattice-based it does suffer from a slower run time than an equally simple lattice-based model, but allows for more accurate modeling of cell-cell interactions.)

Example of cell population at 84 hours starting from a single cell:

![Example Run](ExampleRun.png)

# Basic Simulation

The following is essentially the most basic use of the model. It will be used to demonstrate the package functions available.

```{r}
basic_sim <- runModel(initialNum = 30,
                     runTime =24,
                     density = 0.01,
                     cycleLengthDist = 10 + rexp(1000,1/4),
                     inheritGrowth = FALSE,
                     outputIncrement = 6,
                     randSeed = 0,
                     epsilon = 4,
                     nG = 8)

```

## Parameter Overview

There are 9 parameters for *runModel*, although only the first two need to be provided (initialNum, runTime).

*iinitialNum* - the number of cells in the simulation at time zero  
*runTime* - the number of simulated hours in the run  
*density* - the initial density of the cells  
*cycleLengthDist* - the distribution of cell-cycle length (hrs)  
*inheritGrowth* - T/F for whether cells inherit cell-cycle length from parent  
*outputIncrement* - the amount of time in between outputs while the model is running  
*randSeed* - the random seed used for the simulation  
*epsilon* - model specific parameter  
*nG* - model specific parameter

Most of the parameters are not model specific, but rather apply generally to all cell models. There are two exceptions: *epsilon* and *nG*. These parameters have the same name in @DRASDO2003. More explanation is offered in the next section. 

## Parameter Details

*initialNum*, *density*

The cells are initially seeded randomly throughout a circle, whose radius is calculated based on the density parameter. *density* in this case is defined as
the ratio of the total area of the cells and the area of the circle. Providing a *density* higher than 0.1 will result in an error, since the program cannot efficiently seed cells that close together. Cells are seeded randomly throughout the cell-cycle.

*runTime*, *cycleLengthDist*, *outputIncrement*

The model does not have a length scale so the dimensions of the cells are arbitrary, but it does have a time scale. The value passed in *cycleLengthDist* is the average length (in terms of simulation hours) of the cell-cycle for a cell in isolation. *runTime* is the number of simulation hours the model runs for. If a vector is passed in *cycleLengthDist* then it is treated as a distribution of times and each cell is assigned a random value (uniform) from this vector when it is born. *outputIncrement* specifices how much time is in between each display in the console.

*inheritGrowth*

Cells have the option of inheriting the cycle-length from their parent or sampling from *cycleLengthDist* when they are born. This allows for "growth" rates to be affected in a heritable way.

*epsilon, nG*

In order to understand these parameters, it is neccesary to understand some basic things about the model. Cells primarily do two things: move and grow. When a cell grows to twice its original volume, it divides. This process happens at a rate depending on what the user sets *cycleLengthDist* to be. Cells move in order to arrange themselves to respect the intercellular forces mentioned in the introduction. High values for *epsilon* make it less likely for cells to move against the intercelluar forces. High values for *nG* give the model more time in between growth steps to find the ideal configuration based on the present intercellular forces. For a more detailed explanation of these parameters it is best to read the article (note that the casual user should always use the default values of these parameters).

*randSeed*

The user can pass in a random seed of their choosing. All random samples in the model will be affected by this seed. The default seed is 0.

## Output Analysis - Package Functions

There are several functions used to get relevant information from the *CellModel* object. It is not recommended to pull data directly from the fields in the *CellModel* object since it is the raw data from the model.

```{r}
## should never call these

# basic_sim@cells
# basic_sim@parameters
```

### *getParameters*

This is the function used to get any information about the parameters passed into the model. There are two versions of this function. First, it can be called with just the *CellModel* object, in which case it will return all parameters with one exception: only the mean of *cycleLengthDistribution* will be returned.

```{r}
getParameters(basic_sim) 
```

In order to see the full distribution that was passed in, it is neccesary to specifiy:

```{r}
d <- getParameters(basic_sim, fullDist=TRUE)$cycleLengthDist
plot(density(d),main="Cycle Length Distribution - Parameter",xlab="length")
```

### *getNumberOfCells*

This function returns the total number of cells at a given time.

```{r}
length <- getParameters(basic_sim)$runTime
t <- sapply(0:length,getNumberOfCells,model=basic_sim)
plot(0:length, t, type = "l", xlab="time", ylab="# of cells")
```

### *getCycleLengthDistribution*

This function returns the distribution of cell-cycle lengths at a given time.

```{r}
cyc_len <- getCycleLengthDistribution(basic_sim,0)
plot(density(cyc_len),main="Cycle Length Distribution - Time 0",xlab="length")
```

### *getDensity*

This function returns the density of the cell population at a given time.

```{r}
den <- sapply(0:length,getDensity,model=basic_sim)
plot(0:length,den,type="l",xlab="time",ylab="cell density")
```

### *plotCellsAtTime*

This function plots a visual representation of the cells at a given time.

```{r}
plotCellsAtTime(basic_sim,0)
plotCellsAtTime(basic_sim,length)
```

### *plotInteractive*

```
Basic Commands: 
 b = back one timestep 
 n = forward one timestep 
 s = summary of cells 
 q = quit "console"
 h = basic command help
```

The *plotInteractive* function is similiar to *plotCellsAtTime* except there are additional commands that allow the user to step through the simulation and watch it progress as well as display information at the current timestep.

## References
